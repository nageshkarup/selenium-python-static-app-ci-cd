name: Deploy and Run Cross-Browser Tests Locally

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]  # Add more browsers if needed

    steps:
    - name: Checkout code
      uses: actions/checkout@v3  

    - name: Set up Python
      uses: actions/setup-python@v3  
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install -r requirements.txt

    - name: Set up WebDriver for Pre-Installed Browsers
      run: |
        if [[ "${{ matrix.browser }}" == "chrome" ]]; then
          # Use pre-installed Chrome and set up ChromeDriver
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+' | cut -d '.' -f 1)
          LATEST_DRIVER=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
          wget -q "https://chromedriver.storage.googleapis.com/${LATEST_DRIVER}/chromedriver_linux64.zip"
          unzip chromedriver_linux64.zip -d /usr/local/bin/
          echo "ChromeDriver installed for Chrome version $CHROME_VERSION"
        elif [[ "${{ matrix.browser }}" == "firefox" ]]; then
          # Use pre-installed Firefox and set up GeckoDriver
          FIREFOX_VERSION=$(firefox --version | grep -oP '\d+\.\d+')
          wget -q "https://github.com/mozilla/geckodriver/releases/latest/download/geckodriver-v0.33.0-linux64.tar.gz"
          tar -xzf geckodriver-v0.33.0-linux64.tar.gz -C /usr/local/bin/
          echo "GeckoDriver installed for Firefox version $FIREFOX_VERSION"
        fi

    - name: Make script executable
      run: chmod +x run_tests.sh

    - name: Run tests using script
      env:
        BROWSER: ${{ matrix.browser }}  # Pass the browser to the script
      run: ./run_tests.sh
